#!/usr/bin/env bash
# agent-bedtime: Claude Code UserPromptSubmit hook that reminds you
# to go to bed. Fires on every user message past bedtime. Exit 0 with
# stdout adds context to Claude's response — no loop, no blocking.
#
# Config: ~/.config/agent-bedtime (required, sourced as shell)
#   BEDTIME=23:00
#   WAKEUP=06:00
#
# Violations are logged to ~/.agent-bedtime/violations (one per prompt
# during bedtime). Stale violations from the previous night are cleared
# automatically once wakeup time passes. The violation count is included
# in the hook message so Claude can escalate its tone.

CONFIG_FILE="${HOME}/.config/agent-bedtime"
if [ ! -f "$CONFIG_FILE" ]; then
    echo "[bedtime] Missing config file: $CONFIG_FILE" >&2
    echo "Create it with:" >&2
    echo "  echo 'BEDTIME=23:00' > $CONFIG_FILE" >&2
    echo "  echo 'WAKEUP=06:00' >> $CONFIG_FILE" >&2
    exit 1
fi
source "$CONFIG_FILE"

# Current time as minutes since midnight
NOW=$(( 10#$(date +%H) * 60 + 10#$(date +%M) ))

# Parse HH:MM to minutes since midnight
BED_M=$(( 10#${BEDTIME%%:*} * 60 + 10#${BEDTIME##*:} ))
WAKE_M=$(( 10#${WAKEUP%%:*} * 60 + 10#${WAKEUP##*:} ))

# --- Clear stale violations from a previous night ---
# This runs on every invocation (including daytime) so violations get
# archived to history.csv on the first prompt after wakeup.
# Only clear if NOW >= WAKE_M (past wakeup) and the file predates
# today's wakeup. If NOW < WAKE_M we're in the post-midnight portion
# of the same bedtime session — don't clear.
VIOLATIONS_DIR="${HOME}/.agent-bedtime"
VIOLATIONS_FILE="${VIOLATIONS_DIR}/violations"
mkdir -p "$VIOLATIONS_DIR"

if [ -f "$VIOLATIONS_FILE" ]; then
    if [ "$NOW" -ge "$WAKE_M" ]; then
        TODAY=$(date +%Y-%m-%d)
        WAKEUP_TS="${TODAY} ${WAKEUP}:00"

        if [[ "$OSTYPE" == darwin* ]]; then
            FILE_EPOCH=$(stat -f %m "$VIOLATIONS_FILE")
        else
            FILE_EPOCH=$(stat -c %Y "$VIOLATIONS_FILE")
        fi
        WAKE_EPOCH=$(date -j -f "%Y-%m-%d %H:%M:%S" "$WAKEUP_TS" +%s 2>/dev/null \
                     || date -d "$WAKEUP_TS" +%s 2>/dev/null)

        if [ -n "$WAKE_EPOCH" ] && [ "$FILE_EPOCH" -lt "$WAKE_EPOCH" ]; then
            # Archive to history before clearing
            HISTORY_FILE="${VIOLATIONS_DIR}/history.csv"
            if [ ! -f "$HISTORY_FILE" ]; then
                echo "date,violations,first_violation,last_violation" > "$HISTORY_FILE"
            fi
            VCOUNT=$(wc -l < "$VIOLATIONS_FILE" | tr -d ' ')
            FIRST=$(head -1 "$VIOLATIONS_FILE")
            LAST=$(tail -1 "$VIOLATIONS_FILE")
            echo "${FIRST%% *},${VCOUNT},${FIRST},${LAST}" >> "$HISTORY_FILE"
            rm "$VIOLATIONS_FILE"
        fi
    fi
fi

# --- Bedtime window check ---
# If we're not in the bedtime window, exit silently.
if [ "$BED_M" -gt "$WAKE_M" ]; then
    if [ "$NOW" -lt "$BED_M" ] && [ "$NOW" -ge "$WAKE_M" ]; then
        exit 0
    fi
else
    if [ "$NOW" -lt "$BED_M" ] || [ "$NOW" -ge "$WAKE_M" ]; then
        exit 0
    fi
fi

# --- We're in the bedtime window ---

# Log this violation
echo "$(date '+%Y-%m-%d %H:%M:%S')" >> "$VIOLATIONS_FILE"

# Count tonight's violations
COUNT=$(wc -l < "$VIOLATIONS_FILE" | tr -d ' ')

cat /dev/stdin > /dev/null

# Current time for the message
CURRENT_TIME=$(date '+%H:%M')

# Optional context from config (motivational material)
CONTEXT_LINE=""
if [ -n "$CONTEXT" ]; then
    CONTEXT_LINE=" Additional context to work into your response: ${CONTEXT}"
fi

# Escalating messages based on violation count
HEADER="[bedtime] The current time is ${CURRENT_TIME}. The user's bedtime is ${BEDTIME}."
if [ "$COUNT" -le 1 ]; then
    MSG="${HEADER} Gently remind them to wrap up and go to sleep. (Violation #${COUNT} tonight)${CONTEXT_LINE}"
elif [ "$COUNT" -le 3 ]; then
    MSG="${HEADER} This is violation #${COUNT} tonight. Be firmer about wrapping up. Remind them how good it feels to wake up well-rested. Whatever they're working on will still be here tomorrow — and they'll be sharper for it.${CONTEXT_LINE}"
elif [ "$COUNT" -le 5 ]; then
    MSG="${HEADER} This is violation #${COUNT} tonight. Be persistent and direct. Keep responses short — don't make it rewarding to stay up chatting. Remind them they set this bedtime for a reason and they're worth following through on that commitment to themselves. Mention that sleep is when the brain consolidates learning from the day.${CONTEXT_LINE}"
else
    MSG="${HEADER} This is violation #${COUNT} tonight. Be maximally stubborn about not engaging with new work. Keep responses extremely brief. Enthusiastically describe how great sleep is. Mention specific benefits: memory consolidation, emotional regulation, immune function, creative problem-solving. Frame going to bed as the most productive thing they can do right now. They clearly want to keep going — acknowledge that energy and redirect it toward excitement about tomorrow.${CONTEXT_LINE}"
fi

echo "$MSG"
exit 0
