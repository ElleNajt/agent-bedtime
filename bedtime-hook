#!/usr/bin/env bash
# agent-bedtime: Claude Code Stop hook that reminds you to go to bed.
#
# Fires once per session when it's past bedtime. Uses exit 2 so Claude
# sees the message and reminds the user. Stamps by session_id to avoid
# the infinite loop (exit 2 -> Claude responds -> hook fires -> ...).
#
# Config: ~/.config/agent-bedtime (sourced as shell, live-reloaded)
#   BEDTIME_HOUR=23
#   BEDTIME_WAKEUP=6

BEDTIME_HOUR=23
BEDTIME_WAKEUP=6

CONFIG_FILE="${HOME}/.config/agent-bedtime"
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE"

HOUR=$((10#$(date +%H)))

if [ "$HOUR" -lt "$BEDTIME_HOUR" ] && [ "$HOUR" -ge "$BEDTIME_WAKEUP" ]; then
    exit 0
fi

# Read session_id from stdin
INPUT=$(cat)
SESSION_ID=$(echo "$INPUT" | python3 -c "import sys,json; print(json.load(sys.stdin).get('session_id','unknown'))" 2>/dev/null || echo "unknown")

# Once per session to avoid infinite loop (exit 2 triggers Claude,
# Claude responds, hook fires again). One nag per conversation is
# enough â€” if they keep going, they've made their choice.
STAMP_DIR="${TMPDIR:-/tmp}/agent-bedtime"
mkdir -p "$STAMP_DIR"
STAMP_FILE="$STAMP_DIR/$SESSION_ID"

if [ -f "$STAMP_FILE" ]; then
    exit 0
fi
touch "$STAMP_FILE"

echo "[bedtime] It's past your bedtime. Please remind the user to wrap up and go to sleep." >&2
exit 2
